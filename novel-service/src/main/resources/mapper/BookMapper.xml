<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.persistence.mybatis.mapper.IBookMapper">
    
    <resultMap id="BookResultMap" type="com.domain.Book">
        <id property="id" column="ID"/>
        <result property="bookName" column="NOVEL_NAME"/>
        <result property="categoryName" column="CATEGORY_NAME"/>
        <result property="coverImage" column="PICTURE"/>
        <result property="introduction" column="DESCRIPTION"/>
        <result property="authorAccount" column="ACCOUNT"/>
        <result property="authorName" column="AUTHOR_NAME"/>
        <result property="publishTime" column="PUBLISH_TIME"/>
        <result property="clickTime" column="CLICK_TIME"/>
        <result property="clickCount" column="CLICK_NUM"/>
        <result property="createTime" column="ADD_TIME"/>
    </resultMap>
    
    <!-- 分页查询 -->
    <select id="selectPage" resultMap="BookResultMap">
        SELECT * FROM NOVEL_INFO
        <where>
            <if test="categoryName != null and categoryName != ''">
                AND CATEGORY_NAME = #{categoryName}
            </if>
            <if test="authorAccount != null and authorAccount != ''">
                AND ACCOUNT = #{authorAccount}
            </if>
        </where>
        ORDER BY ADD_TIME DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计数量 -->
    <select id="selectCount" resultType="long">
        SELECT COUNT(*) FROM NOVEL_INFO
        <where>
            <if test="categoryName != null and categoryName != ''">
                AND CATEGORY_NAME = #{categoryName}
            </if>
            <if test="authorAccount != null and authorAccount != ''">
                AND ACCOUNT = #{authorAccount}
            </if>
        </where>
    </select>
    
    <!-- 根据作者查询 -->
    <select id="selectByAuthor" resultMap="BookResultMap">
        SELECT * FROM NOVEL_INFO
        WHERE ACCOUNT = #{authorAccount}
        ORDER BY ADD_TIME DESC
    </select>
    
    <!-- 更新点击次数 -->
    <update id="updateClickCount">
        UPDATE NOVEL_INFO
        SET CLICK_NUM = IFNULL(CLICK_NUM, 0) + 1,
            CLICK_TIME = NOW()
        WHERE ID = #{bookId}
    </update>
    
</mapper>

